<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sales Map - Perfect & Final</title>
    <style>
        body { margin:0; font-family:Arial,sans-serif; background:#f4f6f9; }
        #map { height:100vh; width:100%; }
        #sidebar {
            position:fixed; right:0; top:0; width:380px; height:100%;
            background:#fff; padding:20px; overflow-y:auto;
            box-shadow:-5px 0 20px rgba(0,0,0,0.2); z-index:10;
        }
        input, select, textarea, button {
            width:100%; margin:8px 0; padding:12px; border-radius:6px;
            border:1px solid #ccc; font-size:15px; box-sizing:border-box;
        }
        button {
            background:#007bff; color:white; border:none; cursor:pointer;
            font-weight:bold; transition:0.2s;
        }
        button:hover { background:#0056b3; }
        #addCustomerButton { background:#28a745 !important; }
        #saveEditButton { background:#17a2b8 !important; display:none; }
        h2, h3 { margin-top:20px; color:#333; }
        #pin-legend {
            position:fixed; bottom:20px; left:20px; background:white;
            padding:15px; border-radius:10px; box-shadow:0 6px 25px rgba(0,0,0,0.4);
            z-index:1000; font-size:14px;
        }
        .legend-item { display:flex; align-items:center; margin:8px 0; font-weight:600; }
        .legend-color { width:20px; height:20px; border-radius:50%; margin-right:12px; border:3px solid #444; }
        #customer-list-container {
            background:white; padding:30px; margin:60px auto 0;
            width:90%; max-width:900px; border-radius:12px;
            box-shadow:0 10px 40px rgba(0,0,0,0.2);
        }
        #customer-list ul {
            list-style:none; padding:0; margin:0;
            max-height:400px; overflow-y:auto;
            border:1px solid #ddd; border-radius:8px;
        }
        #customer-list li {
            padding:14px 18px; border-bottom:1px solid #eee;
            cursor:pointer; transition:0.2s; font-weight:500;
        }
        #customer-list li:hover { background:#e3f2fd; }
        .priority-urgent { color:#0066ff; font-weight:bold; }
        .priority-high { color:#28a745; font-weight:bold; }
        .priority-medium { color:#ffc107; font-weight:bold; }
        .priority-low { color:#dc3545; font-weight:bold; }
        .priority-never { color:#fd7e14; font-weight:bold; }
        .priority-no { color:#6f42c1; font-weight:bold; }
        .priority-ucc { color:#8B00FF; font-weight:bold; }
        .priority-overdue { color:#ff69b4; font-weight:bold; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
    <h2 style="margin-top:0; color:#007bff;">Sales Customer Map</h2>
    
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="signIn()">Sign In</button>
    <button onclick="signOut()" id="signOutButton" style="display:none">Sign Out</button>
    <p id="auth-status">Not signed in</p>

    <h3>Add New Customer</h3>
    <input id="name" placeholder="Customer Name" disabled>
    <input id="address" placeholder="Full Address (for pin)" disabled>
    <select id="priority" disabled>
        <option value="urgent">Hotlist (Blue)</option>
        <option value="high">High Priority (Green)</option>
        <option value="medium">Medium Priority (Yellow)</option>
        <option value="low">Low Priority (Red)</option>
        <option value="never">New Visit (Orange)</option>
        <option value="no">No Visit (Purple)</option>
        <option value="ucc">UCC (Bright Violet)</option>
    </select>

    <input id="contactName" placeholder="Contact Name" disabled>
    <input id="phone" placeholder="Phone" disabled>
    <input id="emailContact" placeholder="Email" disabled>
    <textarea id="notes" placeholder="Notes" disabled></textarea>
    <input id="lastVisit" type="date" disabled>
    
    <select id="reminders" multiple disabled style="height:100px;">
        <option value="never">Never</option>
        <option value="1 month">1 Month</option>
        <option value="2 months">2 Months</option>
        <option value="3 months">3 Months</option>
        <option value="4 months">4 Months</option>
        <option value="6 months">6 Months</option>
        <option value="12 months">12 Months</option>
    </select>

    <button id="addCustomerButton" onclick="addCustomer()" disabled>Add Customer</button>
    <button id="saveEditButton" onclick="saveEditedCustomer()" disabled>Save Changes</button>

    <h3>Filter</h3>
    <select id="filter" multiple size="8" onchange="applyFilter()" disabled>
        <option value="all" selected>All Customers</option>
        <option value="urgent">Hotlist</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
        <option value="never">New Visit</option>
        <option value="no">No Visit</option>
        <option value="ucc">UCC</option>
        <option value="overdue">Overdue</option>
    </select>

    <h3>Search</h3>
    <input id="search" placeholder="Search by name..." onkeyup="searchCustomers()" disabled>
</div>

<div id="pin-legend">
    <h4>Pin Legend</h4>
    <div class="legend-item"><div class="legend-color" style="background:blue"></div>Hotlist</div>
    <div class="legend-item"><div class="legend-color" style="background:green"></div>High Priority</div>
    <div class="legend-item"><div class="legend-color" style="background:yellow"></div>Medium Priority</div>
    <div class="legend-item"><div class="legend-color" style="background:red"></div>Low Priority</div>
    <div class="legend-item"><div class="legend-color" style="background:orange"></div>New Visit</div>
    <div class="legend-item"><div class="legend-color" style="background:purple"></div>No Visit</div>
    <div class="legend-item"><div class="legend-color" style="background:#8B00FF"></div>UCC (Bright Violet)</div>
    <div class="legend-item"><div class="legend-color" style="background:pink"></div>Overdue</div>
</div>

<div id="customer-list-container">
    <h3 style="text-align:center; margin-bottom:15px; color:#007bff;">Customer List</h3>
    <div id="customer-list"><ul id="customer-list-ul"></ul></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
    firebase.initializeApp({
        apiKey: "AIzaSyA1aUdvuhzMqJAKGNy0ttDVS-QZNib30ZY",
        authDomain: "sales-map-ac968.firebaseapp.com",
        databaseURL: "https://sales-map-ac968-default-rtdb.firebaseio.com",
        projectId: "sales-map-ac968",
        storageBucket: "sales-map-ac968.firebasestorage.app",
        messagingSenderId: "758371444111",
        appId: "1:758371444111:web:a5f0f425522e1bf536d7fa"
    });

    const db = firebase.database().ref("customers");
    let map, markers = [], currentInfoWindow, editingId = null;

    firebase.auth().onAuthStateChanged(user => {
        const disabled = !user;
        document.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = disabled);
        document.getElementById("auth-status").textContent = user ? `Signed in as ${user.email}` : "Not signed in";
        document.getElementById("signOutButton").style.display = user ? "block" : "none";
        if (user) loadCustomers();
        else { window.customers = []; initMap(); }
    });

    function signIn() {
        firebase.auth().signInWithEmailAndPassword(email.value, password.value)
            .catch(e => alert(e.message));
    }

    function signOut() { firebase.auth().signOut(); }

    function loadCustomers() {
        db.on("value", snap => {
            window.customers = snap.val() ? Object.entries(snap.val()).map(([id, v]) => ({id, ...v})) : [];
            initMap(getFilters());
        });
    }

    function geocode(addr, cb) {
        new google.maps.Geocoder().geocode({address: addr}, (res, status) => {
            if (status === "OK") {
                cb({
                    lat: res[0].geometry.location.lat(),
                    lng: res[0].geometry.location.lng(),
                    addr: res[0].formatted_address
                });
            } else cb(null);
        });
    }

    function addCustomer() {
        geocode(address.value, r => {
            if (!r) return alert("Invalid address");
            db.push({
                name: name.value.trim() || "Unnamed Customer",
                address: r.addr, lat: r.lat, lng: r.lng,
                priority: priority.value,
                contactName: contactName.value,
                phone: phone.value,
                emailContact: emailContact.value,
                notes: notes.value,
                lastVisit: lastVisit.value,
                reminders: [...reminders.selectedOptions].map(o => o.value)
            });
            clearForm();
        });
    }

    function editCustomer(id) {
        const c = window.customers.find(x => x.id === id);
        if (!c) return;

        document.getElementById("name").value = c.name || "Unnamed Customer";
        document.getElementById("address").value = c.address || "";
        document.getElementById("priority").value = c.priority || "urgent";
        document.getElementById("contactName").value = c.contactName || "";
        document.getElementById("phone").value = c.phone || "";
        document.getElementById("emailContact").value = c.emailContact || "";
        document.getElementById("notes").value = c.notes || "";
        document.getElementById("lastVisit").value = c.lastVisit || "";

        [...reminders.options].forEach(o => o.selected = (c.reminders || []).includes(o.value));

        editingId = id;
        saveEditButton.style.display = "block";
        addCustomerButton.style.display = "none";
    }

    function saveEditedCustomer() {
        geocode(address.value, r => {
            if (!r) return alert("Invalid address");
            db.child(editingId).set({
                name: name.value.trim() || "Unnamed Customer",
                address: r.addr, lat: r.lat, lng: r.lng,
                priority: priority.value,
                contactName: contactName.value,
                phone: phone.value,
                emailContact: emailContact.value,
                notes: notes.value,
                lastVisit: lastVisit.value,
                reminders: [...reminders.selectedOptions].map(o => o.value)
            });
            clearForm();
            editingId = null;
            saveEditButton.style.display = "none";
            addCustomerButton.style.display = "block";
        });
    }

    function deleteCustomer(id) {
        if (confirm("Delete this customer?")) db.child(id).remove();
    }

    function clearForm() {
        document.querySelectorAll("#name,#address,#contactName,#phone,#emailContact,#notes,#lastVisit").forEach(i => i.value = "");
        priority.value = "urgent";
        [...reminders.options].forEach(o => o.selected = false);
    }

    function isOverdue(c) {
        if (!c.lastVisit || !c.reminders || c.reminders.includes("never")) return false;
        return c.reminders.some(r => {
            const m = parseInt(r);
            if (!m) return false;
            const d = new Date(c.lastVisit);
            d.setMonth(d.getMonth() + m);
            return d < new Date();
        });
    }

    function getFilters() {
        return [...filter.selectedOptions].map(o => o.value);
    }

    function applyFilter() { initMap(getFilters()); }
    function searchCustomers() { initMap(getFilters(), search.value.toLowerCase()); }

    function initMap(filters = ["all"], searchTerm = "") {
        if (!map) {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 7,
                center: { lat: 35.7796, lng: -78.6382 }
            });
        }

        markers.forEach(m => m.setMap(null));
        markers = [];
        document.getElementById("customer-list-ul").innerHTML = "";

        const filtered = window.customers
            .filter(c => {
                const overdue = isOverdue(c);
                const matchFilter = filters.includes("all") || filters.includes(c.priority) || (filters.includes("overdue") && overdue);
                const matchSearch = !searchTerm || (c.name || "").toLowerCase().includes(searchTerm);
                return matchFilter && matchSearch;
            })
            .sort((a, b) => (a.name || "").localeCompare(b.name || ""));

        filtered.forEach(c => {
            const li = document.createElement("li");
            li.textContent = c.name || "Unnamed Customer";
            li.className = isOverdue(c) ? "priority-overdue" : `priority-${c.priority}`;
            li.onclick = () => {
                map.setCenter({lat: c.lat, lng: c.lng});
                map.setZoom(16);
            };
            document.getElementById("customer-list-ul").appendChild(li);

            if (!c.lat || !c.lng) return;

            const color = isOverdue(c) ? "pink" :
                c.priority === "ucc" ? "purple" :
                {urgent:"blue",high:"green",medium:"yellow",low:"red",never:"orange",no:"purple"}[c.priority] || "gray";

            const marker = new google.maps.Marker({
                position: {lat: c.lat, lng: c.lng},
                map: map,
                title: c.name || "Unnamed Customer",
                icon: `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`
            });

            const info = new google.maps.InfoWindow({
                content: `<div style="font-size:14px;">
                    <h3>${c.name || "Unnamed Customer"}</h3>
                    <p><strong>Address:</strong> ${c.address || "N/A"}</p>
                    <p><strong>Contact:</strong> ${c.contactName || "N/A"}</p>
                    <p><strong>Phone:</strong> ${c.phone || "N/A"}</p>
                    <button onclick="editCustomer('${c.id}')" style="margin:5px;padding:6px 10px;">Edit</button>
                    <button onclick="deleteCustomer('${c.id}')" style="margin:5px;padding:6px 10px;background:#dc3545;">Delete</button>
                </div>`
            });

            marker.addListener("click", () => {
                if (currentInfoWindow) currentInfoWindow.close();
                info.open(map, marker);
                currentInfoWindow = info;
            });

            markers.push(marker);
        });
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAk5eJEWBbPMOJjybLkJvQ9vJgvFw87030&callback=initMap" async defer></script>
</body>
</html>
