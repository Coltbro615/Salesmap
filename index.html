<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sales Map + Route Optimization</title>
<style>
    body{margin:0;font-family:Arial,sans-serif}
    #main-container{display:flex;height:100vh;position:relative}
    #map{width:70%;height:100%}
    #sidebar{width:30%;padding:15px;background:#f8f9fa;overflow-y:auto;z-index:10}
    #route-panel{width:30%;background:#fff;border-left:3px solid #007bff;padding:15px;position:absolute;right:0;top:0;height:100%;overflow-y:auto;display:none;z-index:20;box-shadow:-5px 0 15px rgba(0,0,0,0.2)}
    input,select,textarea,button{width:100%;margin:8px 0;padding:10px;box-sizing:border-box;border-radius:4px}
    button{background:#007bff;color:white;border:none;cursor:pointer;font-weight:bold}
    button:hover{background:#0056b3}
    #optimize-btn{background:#28a745 !important}
    #clear-route-btn{background:#dc3545 !important}
    #pin-legend{position:absolute;bottom:20px;left:20px;background:white;padding:12px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:1000;font-size:14px}
    .legend-item{display:flex;align-items:center;margin:6px 0;font-weight:600}
    .legend-color{width:18px;height:18px;border-radius:50%;margin-right:10px;border:2px solid #444}
    .priority-urgent{color:blue;font-weight:bold}
    .priority-high{color:green;font-weight:bold}
    .priority-medium{color:#b8860b;font-weight:bold}
    .priority-low{color:red;font-weight:bold}
    .priority-never{color:orange;font-weight:bold}
    .priority-no{color:purple;font-weight:bold}
    .priority-ucc{color:#8B00FF;font-weight:bold}
    .priority-overdue{color:deeppink;font-weight:bold}
    #customer-list ul{list-style:none;padding:0;margin:0}
    #customer-list li{padding:12px;border-bottom:1px solid #eee;cursor:pointer;transition:0.2s}
    #customer-list li:hover{background:#e3f2fd}
    #customer-list li.selected{background:#1976d2 !important;color:white !important;font-weight:bold}
    .directions{margin:10px 0;padding:12px;background:#f5f5f5;border-left:4px solid #007bff;border-radius:4px}
</style>
</head>
<body>
<div id="main-container">
    <div id="map"></div>
    <div id="sidebar">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button onclick="signIn()">Sign In</button>
        <button onclick="signOut()" id="signOutButton" style="display:none">Sign Out</button>
        <p id="auth-status">Not signed in</p>

        <h2>Add/Edit Customer</h2>
        <input id="name" placeholder="Customer Name" disabled>
        <input id="address" placeholder="Customer Address" disabled>
        <select id="priority" disabled>
            <option value="urgent">Hotlist (Blue)</option>
            <option value="high">High Priority (Green)</option>
            <option value="medium">Medium Priority (Yellow)</option>
            <option value="low">Low Priority (Red)</option>
            <option value="never">New Visit (Orange)</option>
            <option value="no">No Visit (Purple)</option>
            <option value="ucc">UCC (Bright Violet)</option>
        </select>
        <input id="contactName" placeholder="Contact Name" disabled>
        <input id="phone" placeholder="Phone" disabled>
        <input id="emailContact" placeholder="Email" disabled>
        <textarea id="notes" placeholder="Notes" disabled></textarea>
        <input id="lastVisit" type="date" disabled>
        <select id="reminders" multiple disabled>
            <option value="never">Never</option>
            <option value="1 month">1 Month</option>
            <option value="2 months">2 Months</option>
            <option value="3 months">3 Months</option>
            <option value="4 months">4 Months</option>
            <option value="6 months">6 Months</option>
            <option value="12 months">12 Months</option>
        </select>
        <button id="addCustomerButton" onclick="addCustomer()" disabled>Add Customer</button>
        <button id="saveEditButton" onclick="saveEditedCustomer()" style="display:none" disabled>Save Changes</button>

        <h3>Filter</h3>
        <select id="filter" multiple size="8" onchange="applyFilter()" disabled>
            <option value="all" selected>All</option>
            <option value="urgent">Hotlist</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
            <option value="never">New Visit</option>
            <option value="no">No Visit</option>
            <option value="ucc">UCC (Violet)</option>
            <option value="overdue">Overdue</option>
        </select>

        <h3>Search</h3>
        <input id="search" placeholder="Search name" onkeyup="searchCustomers()" disabled>

        <hr>
        <h3>Route Optimization</h3>
        <p><strong>Hold Ctrl (Windows) or Cmd (Mac) + click</strong> to select multiple</p>
        <button id="optimize-btn" onclick="optimizeRoute()">Optimize & Show Route</button>
        <button id="clear-route-btn" onclick="clearRoute()">Clear Route</button>
        <p id="route-info" style="margin-top:10px;font-weight:bold"></p>
    </div>

    <div id="route-panel">
        <h3>Optimized Route <span style="float:right;cursor:pointer;font-size:22px" onclick="clearRoute()">X</span></h3>
        <div id="directions-panel"></div>
    </div>
</div>

<div id="customer-list-container">
    <h3>Customer List</h3>
    <div id="customer-list"><ul id="customer-list-ul"></ul></div>
</div>

<div id="pin-legend">
    <h4>Pin Legend</h4>
    <div class="legend-item"><div class="legend-color" style="background:blue"></div>Hotlist</div>
    <div class="legend-item"><div class="legend-color" style="background:green"></div>High</div>
    <div class="legend-item"><div class="legend-color" style="background:yellow"></div>Medium</div>
    <div class="legend-item"><div class="legend-color" style="background:red"></div>Low</div>
    <div class="legend-item"><div class="legend-color" style="background:orange"></div>New Visit</div>
    <div class="legend-item"><div class="legend-color" style="background:purple"></div>No Visit</div>
    <div class="legend-item"><div class="legend-color" style="background:#8B00FF"></div>UCC (Bright Violet)</div>
    <div class="legend-item"><div class="legend-color" style="background:pink"></div>Overdue</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script>
    firebase.initializeApp({
        apiKey: "AIzaSyA1aUdvuhzMqJAKGNy0ttDVS-QZNib30ZY",
        authDomain: "sales-map-ac968.firebaseapp.com",
        databaseURL: "https://sales-map-ac968-default-rtdb.firebaseio.com",
        projectId: "sales-map-ac968",
        storageBucket: "sales-map-ac968.firebasestorage.app",
        messagingSenderId: "758371444111",
        appId: "1:758371444111:web:a5f0f425522e1bf536d7fa"
    });
    const db = firebase.database().ref("customers");
    let map, markers = [], directionsService, directionsRenderer, currentInfoWindow, editingId;

    firebase.auth().onAuthStateChanged(u => {
        const disabled = !u;
        document.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = disabled);
        document.getElementById("auth-status").textContent = u ? "Signed in as " + u.email : "Not signed in";
        document.getElementById("signOutButton").style.display = u ? "block" : "none";
        if (u) loadCustomers(); else initMap();
    });

    function signIn(){firebase.auth().signInWithEmailAndPassword(email.value, password.value).catch(e=>alert(e.message))}
    function signOut(){firebase.auth().signOut()}
    function loadCustomers(){db.on("value", s => {window.customers = s.val()?Object.entries(s.val()).map(([k,v])=>({id:k,...v})):[];initMap(getFilters())})}

    function geocode(a,cb){new google.maps.Geocoder().geocode({address:a},(r,s)=>{s==="OK"?cb({lat:r[0].geometry.location.lat(),lng:r[0].geometry.location.lng(),addr:r[0].formatted_address}):cb(null)})}
    function addCustomer(){
        geocode(address.value, r => { if(!r)return;
            db.push({name:name.value||"Unnamed",address:r.addr,lat:r.lat,lng:r.lng,priority:priority.value,
                contactName:contactName.value,phone:phone.value,emailContact:emailContact.value,
                notes:notes.value,lastVisit:lastVisit.value,reminders:[...reminders.selectedOptions].map(o=>o.value)});
            clearForm();
        });
    }
    function editCustomer(id){const c=window.customers.find(x=>x.id===id);
        ["name","address","contactName","phone","emailContact","notes","lastVisit"].forEach(f=>document.getElementById(f).value=c[f]||"");
        priority.value=c.priority; [...reminders.options].forEach(o=>o.selected=c.reminders?.includes(o.value));
        editingId=id; saveEditButton.style.display="block"; addCustomerButton.style.display="none";
    }
    function saveEditedCustomer(){
        geocode(address.value, r => { if(!r)return;
            db.child(editingId).set({name:name.value||"Unnamed",address:r.addr,lat:r.lat,lng:r.lng,priority:priority.value,
                contactName:contactName.value,phone:phone.value,emailContact:emailContact.value,notes:notes.value,
                lastVisit:lastVisit.value,reminders:[...reminders.selectedOptions].map(o=>o.value)});
            clearForm(); editingId=null; saveEditButton.style.display="none"; addCustomerButton.style.display="block";
        });
    }
    function deleteCustomer(id){if(confirm("Delete?"))db.child(id).remove()}
    function clearForm(){
        document.querySelectorAll("#name,#address,#contactName,#phone,#emailContact,#notes,#lastVisit").forEach(i=>i.value="");
        priority.value="urgent"; [...reminders.options].forEach(o=>o.selected=false);
    }

    function isOverdue(c){
        if(!c.lastVisit||!c.reminders||c.reminders.includes("never"))return false;
        return c.reminders.some(r=>{const m=parseInt(r);const d=new Date(c.lastVisit);d.setMonth(d.getMonth()+m);return d<new Date()});
    }
    function getFilters(){return [...filter.selectedOptions].map(o=>o.value)}
    function applyFilter(){initMap(getFilters())}
    function searchCustomers(){initMap(getFilters(), search.value.toLowerCase())}

    function initMap(filters=["all"],search=""){
        if(!map){
            map = new google.maps.Map(document.getElementById("map"),{zoom:7,center:{lat:35.7796,lng:-78.6382}});
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({map:map, suppressMarkers:false});
        }
        markers.forEach(m=>m.setMap(null)); markers=[];

        const list = document.getElementById("customer-list-ul"); list.innerHTML="";
        const filtered = window.customers.filter(c=>{
            const overdue=isOverdue(c);
            const f = filters.includes("all")||filters.includes(c.priority)||(filters.includes("overdue")&&overdue);
            const s = !search||c.name.toLowerCase().includes(search);
            return f&&s;
        }).sort((a,b)=>a.name.localeCompare(b.name));

        filtered.forEach(c=>{
            const li=document.createElement("li");
            li.textContent=c.name;
            li.className=`priority-${isOverdue(c)?"overdue":c.priority}`;
            
            // FIXED MULTI-SELECT — prevent default click from deselecting
            li.onclick = function(e){
                if(e.ctrlKey || e.metaKey){
                    e.preventDefault();
                    this.classList.toggle("selected");
                } else {
                    map.setCenter({lat:c.lat,lng:c.lng});
                    map.setZoom(15);
                }
            };
            list.appendChild(li);

            if(!c.lat||!c.lng) return;

            // FIXED UCC PIN — now truly bright violet (#8B00FF)
            const pinColor = isOverdue(c) ? "pink" :
                c.priority === "ucc" ? "https://maps.google.com/mapfiles/ms/micons/purple-dot.png" :  // bright violet
                {urgent:"blue",high:"green",medium:"yellow",low:"red",never:"orange",no:"purple"}[c.priority] || "gray";

            const iconUrl = c.priority === "ucc" ? pinColor : `http://maps.google.com/mapfiles/ms/icons/${pinColor}-dot.png`;

            const marker = new google.maps.Marker({
                position: {lat: c.lat, lng: c.lng},
                map: map,
                title: c.name,
                icon: iconUrl
            });

            marker.addListener("click", ()=>{
                if(currentInfoWindow) currentInfoWindow.close();
                currentInfoWindow = new google.maps.InfoWindow({
                    content: `<h3>${c.name}</h3><p>${c.address}</p><button onclick="editCustomer('${c.id}')">Edit</button> <button onclick="deleteCustomer('${c.id}')">Delete</button>`
                });
                currentInfoWindow.open(map, marker);
            });
            markers.push(marker);
        });
    }

    function optimizeRoute() {
        const selected = document.querySelectorAll("#customer-list-ul li.selected");
        if (selected.length < 2) return alert("Please select at least 2 customers (hold Ctrl/Cmd + click)");

        const stops = Array.from(selected).map(li => {
            const cust = window.customers.find(c => c.name === li.textContent.trim());
            return { location: { lat: cust.lat, lng: cust.lng }, stopover: true };
        });

        directionsService.route({
            origin: stops[0].location,
            destination: stops[stops.length-1].location,
            waypoints: stops.slice(1, -1),
            optimizeWaypoints: true,
            travelMode: "DRIVING"
        }, (res, status) => {
            if (status === "OK") {
                directionsRenderer.setDirections(res);
                document.getElementById("route-panel").style.display = "block";
                document.getElementById("directions-panel").innerHTML = "";
                const route = res.routes[0];
                let html = "";
                route.legs.forEach((leg,i) => {
                    html += `<div class="directions">${i+1}. <strong>${leg.start_address.split(",")[0]}</strong> → ${leg.end_address.split(",")[0]}<br>${leg.distance.text} • ${leg.duration.text}</div>`;
                });
                document.getElementById("directions-panel").innerHTML = html;
                document.getElementById("route-info").textContent = `Optimized: ${selected.length} stops • ${route.legs.reduce((a,l)=>a+l.distance.value,0)/1000|0} km`;
            }
        });
    }

    function clearRoute() {
        directionsRenderer.setDirections({routes:[]});
        document.getElementById("route-panel").style.display = "none";
        document.getElementById("route-info").textContent = "";
        document.querySelectorAll("#customer-list-ul li.selected").forEach(li=>li.classList.remove("selected"));
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAk5eJEWBbPMOJjybLkJvQ9vJgvFw87030&callback=initMap" async defer></script>
</body>
</html>
