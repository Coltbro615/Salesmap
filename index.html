<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sales Map - FINAL PERFECTION</title>
<style>
    body{margin:0;font-family:Arial,sans-serif;background:#f4f6f9}
    #main-container{position:relative;height:100vh}
    #map{height:100vh;width:100%}
    #sidebar{width:380px;position:absolute;top:0;left:0;height:100%;background:#fff;padding:20px;overflow-y:auto;box-shadow:2px 0 15px rgba(0,0,0,0.2);z-index:10}
    #route-panel{width:380px;position:absolute;top:0;right:0;height:100%;background:#fff;padding:20px;overflow-y:auto;box-shadow:-2px 0 15px rgba(0,0,0,0.2);z-index:20;display:none}
    input,select,textarea,button{width:100%;margin:8px 0;padding:12px;border-radius:6px;border:1px solid #ccc;font-size:15px}
    button{background:#007bff;color:white;border:none;cursor:pointer;font-weight:bold}
    button:hover{background:#0056b3}
    #optimize-btn{background:#28a745 !important;padding:16px;font-size:18px}
    #clear-route-btn{background:#dc3545 !important}
    #pin-legend{position:absolute;bottom:20px;left:20px;background:white;padding:15px;border-radius:10px;box-shadow:0 6px 25px rgba(0,0,0,0.4);z-index:1000;font-size:14px}
    .legend-item{display:flex;align-items:center;margin:8px 0;font-weight:600}
    .legend-color{width:20px;height:20px;border-radius:50%;margin-right:12px;border:3px solid #444}
    .priority-urgent{color:blue;font-weight:bold}
    .priority-high{color:green;font-weight:bold}
    .priority-medium{color:#b8860b;font-weight:bold}
    .priority-low{color:red;font-weight:bold}
    .priority-never{color:orange;font-weight:bold}
    .priority-no{color:purple;font-weight:bold}
    .priority-ucc{color:#8B00FF;font-weight:bold}
    .priority-overdue{color:deeppink;font-weight:bold}
    #customer-list-container{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:60%;max-width:800px;background:white;padding:15px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.3);z-index:5}
    #customer-list ul{list-style:none;padding:0;margin:0;max-height:180px;overflow-y:auto}
    #customer-list li{padding:10px 14px;border-bottom:1px solid #eee;cursor:pointer;transition:0.2s}
    #customer-list li:hover{background:#e3f2fd}
    #customer-list li.selected{background:#1976d2;color:white;font-weight:bold}
    .directions{margin:12px 0;padding:14px;background:#f8f9fa;border-left:5px solid #007bff;border-radius:6px}
</style>
</head>
<body>

<div id="main-container">
    <div id="map"></div>

    <!-- LEFT SIDEBAR -->
    <div id="sidebar">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button onclick="signIn()">Sign In</button>
        <button onclick="signOut()" id="signOutButton" style="display:none">Sign Out</button>
        <p id="auth-status">Not signed in</p>

        <h2>Add/Edit Customer</h2>
        <input id="name" placeholder="Customer Name" disabled>
        <input id="address" placeholder="Customer Address" disabled>
        <select id="priority" disabled>
            <option value="urgent">Hotlist (Blue)</option>
            <option value="high">High Priority (Green)</option>
            <option value="medium">Medium Priority (Yellow)</option>
            <option value="low">Low Priority (Red)</option>
            <option value="never">New Visit (Orange)</option>
            <option value="no">No Visit (Purple)</option>
            <option value="ucc">UCC (Bright Violet)</option>
        </select>
        <input id="contactName" placeholder="Contact Name" disabled>
        <input id="phone" placeholder="Phone" disabled>
        <input id="emailContact" placeholder="Email" disabled>
        <textarea id="notes" placeholder="Notes" disabled></textarea>
        <input id="lastVisit" type="date" disabled>
        <select id="reminders" multiple disabled>
            <option value="never">Never</option>
            <option value="1 month">1 Month</option>
            <option value="2 months">2 Months</option>
            <option value="3 months">3 Months</option>
            <option value="4 months">4 Months</option>
            <option value="6 months">6 Months</option>
            <option value="12 months">12 Months</option>
        </select>
        <button id="addCustomerButton" onclick="addCustomer()" disabled>Add Customer</button>
        <button id="saveEditButton" onclick="saveEditedCustomer()" style="display:none" disabled>Save Changes</button>

        <h3>Filter</h3>
        <select id="filter" multiple size="8" onchange="applyFilter()" disabled>
            <option value="all" selected>All</option>
            <option value="urgent">Hotlist</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
            <option value="never">New Visit</option>
            <option value="no">No Visit</option>
            <option value="ucc">UCC</option>
            <option value="overdue">Overdue</option>
        </select>

        <h3>Search</h3>
        <input id="search" placeholder="Search name" onkeyup="searchCustomers()" disabled>

        <hr>
        <h3>Route Optimization</h3>
        <p><strong>Click pins</strong> to select • <strong>Double-click</strong> to edit</p>
        <button id="optimize-btn" onclick="optimizeRoute()">Optimize & Show Route</button>
        <button id="clear-route-btn" onclick="clearRoute()">Clear Route</button>
        <p id="route-info" style="margin-top:15px;font-weight:bold;color:#28a745">Click pins to select</p>
    </div>

    <!-- RIGHT ROUTE PANEL -->
    <div id="route-panel">
        <h3>Optimized Route <span style="float:right;cursor:pointer;font-size:24px" onclick="clearRoute()">×</span></h3>
        <div id="directions-panel"></div>
    </div>

    <!-- CUSTOMER LIST UNDER MAP -->
    <div id="customer-list-container">
        <h3 style="margin:0 0 10px;text-align:center">Customer List</h3>
        <div id="customer-list"><ul id="customer-list-ul"></ul></div>
    </div>

    <!-- PIN LEGEND -->
    <div id="pin-legend">
        <h4>Pin Legend</h4>
        <div class="legend-item"><div class="legend-color" style="background:blue"></div>Hotlist</div>
        <div class="legend-item"><div class="legend-color" style="background:green"></div>High</div>
        <div class="legend-item"><div class="legend-color" style="background:yellow"></div>Medium</div>
        <div class="legend-item"><div class="legend-color" style="background:red"></div>Low</div>
        <div class="legend-item"><div class="legend-color" style="background:orange"></div>New Visit</div>
        <div class="legend-item"><div class="legend-color" style="background:purple"></div>No Visit</div>
        <div class="legend-item"><div class="legend-color" style="background:#8B00FF"></div>UCC (Bright Violet)</div>
        <div class="legend-item"><div class="legend-color" style="background:pink"></div>Overdue</div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script>
    firebase.initializeApp({
        apiKey: "AIzaSyA1aUdvuhzMqJAKGNy0ttDVS-QZNib30ZY",
        authDomain: "sales-map-ac968.firebaseapp.com",
        databaseURL: "https://sales-map-ac968-default-rtdb.firebaseio.com",
        projectId: "sales-map-ac968",
        storageBucket: "sales-map-ac968.firebasestorage.app",
        messagingSenderId: "758371444111",
        appId: "1:758371444111:web:a5f0f425522e1bf536d7fa"
    });
    const db = firebase.database().ref("customers");
    let map, markers = [], directionsService, directionsRenderer, currentInfoWindow, editingId;
    const selectedIds = new Set();

    firebase.auth().onAuthStateChanged(u => {
        const disabled = !u;
        document.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = disabled);
        document.getElementById("auth-status").textContent = u ? "Signed in as " + u.email : "Not signed in";
        document.getElementById("signOutButton").style.display = u ? "block" : "none";
        if (u) loadCustomers(); else initMap();
    });

    function signIn(){firebase.auth().signInWithEmailAndPassword(email.value, password.value).catch(e=>alert(e.message))}
    function signOut(){firebase.auth().signOut()}
    function loadCustomers(){db.on("value", s => {window.customers = s.val()?Object.entries(s.val()).map(([k,v])=>({id:k,...v})):[];initMap(getFilters())})}

    function geocode(a,cb){new google.maps.Geocoder().geocode({address:a},(r,s)=>{s==="OK"?cb({lat:r[0].geometry.location.lat(),lng:r[0].geometry.location.lng(),addr:r[0].formatted_address}):cb(null)})}
    function addCustomer(){
        geocode(address.value, r => { if(!r)return alert("Invalid address");
            db.push({name:name.value||"Unnamed",address:r.addr,lat:r.lat,lng:r.lng,priority:priority.value,
                contactName:contactName.value,phone:phone.value,emailContact:emailContact.value,notes:notes.value,
                lastVisit:lastVisit.value,reminders:[...reminders.selectedOptions].map(o=>o.value)});
            clearForm();
        });
    }
    function editCustomer(id){const c=window.customers.find(x=>x.id===id);
        ["name","address","contactName","phone","emailContact","notes","lastVisit"].forEach(f=>document.getElementById(f).value=c[f]||"");
        priority.value=c.priority; [...reminders.options].forEach(o=>o.selected=c.reminders?.includes(o.value));
        editingId=id; saveEditButton.style.display="block"; addCustomerButton.style.display="none";
    }
    function saveEditedCustomer(){
        geocode(address.value, r => { if(!r)return alert("Invalid address");
            db.child(editingId).set({name:name.value||"Unnamed",address:r.addr,lat:r.lat,lng:r.lng,priority:priority.value,
                contactName:contactName.value,phone:phone.value,emailContact:emailContact.value,notes:notes.value,
                lastVisit:lastVisit.value,reminders:[...reminders.selectedOptions].map(o=>o.value)});
            clearForm(); editingId=null; saveEditButton.style.display="none"; addCustomerButton.style.display="block";
        });
    }
    function deleteCustomer(id){if(confirm("Delete this customer?")) db.child(id).remove()}
    function clearForm(){
        document.querySelectorAll("#name,#address,#contactName,#phone,#emailContact,#notes,#lastVisit").forEach(i=>i.value="");
        priority.value="urgent"; [...reminders.options].forEach(o=>o.selected=false);
    }

    function isOverdue(c){
        if(!c.lastVisit||!c.reminders||c.reminders.includes("never")) return false;
        return c.reminders.some(r=>{const m=parseInt(r);if(!m)return false;const d=new Date(c.lastVisit);d.setMonth(d.getMonth()+m);return d<new Date()});
    }
    function getFilters(){return [...filter.selectedOptions].map(o=>o.value)}
    function applyFilter(){initMap(getFilters())}
    function searchCustomers(){initMap(getFilters(), search.value.toLowerCase())}

    function initMap(filters=["all"],search=""){
        if(!map){
            map = new google.maps.Map(document.getElementById("map"),{zoom:7,center:{lat:35.7796,lng:-78.6382}});
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({map:map, suppressMarkers:false});
        }
        markers.forEach(m=>m.setMap(null)); markers=[]; selectedIds.clear();
        document.getElementById("customer-list-ul").innerHTML="";

        const filtered = window.customers.filter(c=>{
            const overdue=isOverdue(c);
            const f = filters.includes("all")||filters.includes(c.priority)||(filters.includes("overdue")&&overdue);
            const s = !search||c.name.toLowerCase().includes(search);
            return f&&s;
        }).sort((a,b)=>a.name.localeCompare(b.name));

        filtered.forEach(c=>{
            const li=document.createElement("li");
            li.textContent=c.name;
            li.className = isOverdue(c) ? "priority-overdue" : `priority-${c.priority}`;
            li.onclick = () => {
                const marker = markers.find(m=>m.customerId===c.id);
                if(marker) toggleSelection(c.id, marker, li);
            };
            document.getElementById("customer-list-ul").appendChild(li);

            if(!c.lat||!c.lng) return;

            const color = isOverdue(c) ? "pink" :
                c.priority==="ucc" ? "purple" :
                {urgent:"blue",high:"green",medium:"yellow",low:"red",never:"orange",no:"purple"}[c.priority] || "gray";

            const marker = new google.maps.Marker({
                position: {lat:c.lat, lng:c.lng},
                map: map,
                title: c.name,
                icon: `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
                customerId: c.id
            });

            marker.addListener("click", () => toggleSelection(c.id, marker, li));
            marker.addListener("dblclick", () => {
                if(currentInfoWindow) currentInfoWindow.close();
                currentInfoWindow = new google.maps.InfoWindow({
                    content: `<h3>${c.name}</h3><p>${c.address}</p><button onclick="editCustomer('${c.id}')">Edit</button> <button onclick="deleteCustomer('${c.id}')">Delete</button>`
                });
                currentInfoWindow.open(map, marker);
            });

            markers.push(marker);
        });
        document.getElementById("route-info").textContent = "Click pins to select • Double-click to edit";
    }

    function toggleSelection(id, marker, listItem) {
        if(selectedIds.has(id)){
            selectedIds.delete(id);
            marker.setIcon(marker.getIcon());
            listItem.classList.remove("selected");
        } else {
            selectedIds.add(id);
            marker.setIcon({url: marker.getIcon().url, scaledSize: new google.maps.Size(48,48)});
            listItem.classList.add("selected");
        }
        document.getElementById("route-info").textContent = `${selectedIds.size} selected → Click Optimize`;
    }

    function optimizeRoute() {
        if(selectedIds.size < 2) return alert("Select at least 2 pins first!");
        const selected = Array.from(selectedIds).map(id => window.customers.find(c=>c.id===id));
        if(selected.some(c=>!c.lat||!c.lng)) return alert("One of the selected customers has no location");

        const waypoints = selected.slice(1,-1).map(c=>({location:{lat:c.lat,lng:c.lng},stopover:true}));

        directionsService.route({
            origin: {lat:selected[0].lat, lng:selected[0].lng},
            destination: {lat:selected[selected.length-1].lat, lng:selected[selected.length-1].lng},
            waypoints: waypoints,
            optimizeWaypoints: true,
            travelMode: google.maps.TravelMode.DRIVING
        }, (res, status) => {
            if(status==="OK"){
                directionsRenderer.setDirections(res);
                document.getElementById("route-panel").style.display="block";
                document.getElementById("directions-panel").innerHTML="";
                const route = res.routes[0];
                let html="";
                route.legs.forEach((leg,i)=>{
                    html += `<div class="directions">${i+1}. <strong>${selected[i].name}</strong> → ${selected[i+1].name}<br>${leg.distance.text} • ${leg.duration.text}</div>`;
                });
                document.getElementById("directions-panel").innerHTML=html;
                document.getElementById("route-info").textContent=`Optimized ${selected.length} stops!`;
            } else {
                alert("Route failed: " + status);
            }
        });
    }

    function clearRoute() {
        directionsRenderer.setDirections({routes:[]});
        document.getElementById("route-panel").style.display="none";
        document.getElementById("route-info").textContent="Click pins to select • Double-click to edit";
        document.querySelectorAll("#customer-list-ul li.selected").forEach(li=>li.classList.remove("selected"));
        markers.forEach(m=>m.setIcon(m.getIcon()));
        selectedIds.clear();
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAk5eJEWBbPMOJjybLkJvQ9vJgvFw87030&callback=initMap" async defer></script>
</body>
</html>
