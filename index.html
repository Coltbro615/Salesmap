<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sales Map</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; height: auto; }
        #main-container { display: flex; }
        #map {
            height: 100vh;
            min-height: 100vh;
            width: 70%;
            min-width: 70%;
            position: relative;
            display: block;
        }
        #sidebar { height: 100vh; width: 30%; padding: 10px; background: #f0f0f0; overflow-y: auto; }
        #customer-list-container { width: 100%; background: #f0f0f0; padding: 10px; }
        #customer-list { height: 400px; overflow-y: auto; }
        #customer-list ul { list-style: none; padding: 0; margin: 0; }
        #customer-list li { padding: 8px 5px; cursor: pointer; border-bottom: 1px solid #ddd; }
        #customer-list li:hover { background: #ddd; }
        input, textarea, select { width: 100%; margin: 5px 0; padding: 8px; box-sizing: border-box; }
        button { margin: 5px 0; padding: 10px; }
        #pin-legend {
            position: absolute;
            bottom: 50px;
            left: 20px;
            background: white;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .legend-item { display: flex; align-items: center; margin: 8px 0; font-weight: 500; }
        .legend-color { width: 20px; height: 20px; margin-right: 10px; border-radius: 50%; border: 2px solid #555; }
        #auth-container { margin-bottom: 10px; }
        #filter { height: 120px; }
        #notes-section textarea { height: 100px; }

        /* Priority text colors in customer list */
        .priority-urgent { color: blue; font-weight: bold; }
        .priority-high { color: green; font-weight: bold; }
        .priority-medium { color: #d4a017; font-weight: bold; }
        .priority-low { color: red; font-weight: bold; }
        .priority-never { color: orange; font-weight: bold; }
        .priority-no { color: purple; font-weight: bold; }
        .priority-ucc { color: #8B00FF; font-weight: bold; }   /* UCC - Bright Violet */
        .priority-overdue { color: deeppink; font-weight: bold; }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="map"></div>
        <div id="sidebar">
            <div id="auth-container">
                <input id="email" type="email" placeholder="Email">
                <input id="password" type="password" placeholder="Password">
                <button onclick="signIn()">Sign In</button>
                <button onclick="signOut()" id="signOutButton" style="display: none;">Sign Out</button>
                <p id="auth-status">Not signed in</p>
            </div>

            <h2>Add/Edit Customer</h2>
            <input id="name" placeholder="Customer Name" disabled>
            <input id="address" placeholder="Customer Address" disabled>
            <select id="priority" disabled>
                <option value="urgent">Hotlist (Blue)</option>
                <option value="high">High Priority (Green)</option>
                <option value="medium">Medium Priority (Yellow)</option>
                <option value="low">Low Priority (Red)</option>
                <option value="never">New Visit (Orange)</option>
                <option value="no">No Visit (Purple)</option>
                <option value="ucc">UCC (Violet)</option> <!-- NEW UCC OPTION -->
            </select>

            <div id="notes-section">
                <input id="contactName" placeholder="Contact Name" disabled>
                <input id="phone" type="tel" placeholder="Phone Number" disabled>
                <input id="emailContact" type="email" placeholder="Email Address" disabled>
                <textarea id="notes" placeholder="Additional Notes" disabled></textarea>
            </div>

            <input id="lastVisit" type="date" disabled>
            <select id="reminders" multiple disabled>
                <option value="never">Never</option>
                <option value="1 month">1 Month</option>
                <option value="2 months">2 Months</option>
                <option value="3 months">3 Months</option>
                <option value="4 months">4 Months</option>
                <option value="6 months">6 Months</option>
                <option value="12 months">12 Months</option>
            </select>

            <button id="addCustomerButton" onclick="addCustomer()" disabled>Add Customer</button>
            <button id="saveEditButton" onclick="saveEditedCustomer()" style="display: none;" disabled>Save Changes</button>

            <h3>Filter by Priority</h3>
            <select id="filter" multiple onchange="applyFilter()" disabled>
                <option value="all" selected>All</option>
                <option value="urgent">Hotlist (Blue)</option>
                <option value="high">High (Green)</option>
                <option value="medium">Medium (Yellow)</option>
                <option value="low">Low (Red)</option>
                <option value="never">New Visit (Orange)</option>
                <option value="no">No Visit (Purple)</option>
                <option value="ucc">UCC (Violet)</option> <!-- NEW FILTER OPTION -->
                <option value="overdue">Overdue (Pink)</option>
            </select>

            <h3>Search Customer</h3>
            <input id="search" placeholder="Search by name" disabled onkeyup="searchCustomers()">
        </div>
    </div>

    <div id="customer-list-container">
        <h3>Customer List</h3>
        <div id="customer-list">
            <ul id="customer-list-ul"></ul>
        </div>
    </div>

    <!-- Map Legend - UCC Added -->
    <div id="pin-legend">
        <h4>Pin Color Legend</h4>
        <div class="legend-item"><div class="legend-color" style="background-color: blue;"></div>Hotlist</div>
        <div class="legend-item"><div class="legend-color" style="background-color: green;"></div>High Priority</div>
        <div class="legend-item"><div class="legend-color" style="background-color: yellow;"></div>Medium Priority</div>
        <div class="legend-item"><div class="legend-color" style="background-color: red;"></div>Low Priority</div>
        <div class="legend-item"><div class="legend-color" style="background-color: orange;"></div>New Visit</div>
        <div class="legend-item"><div class="legend-color" style="background-color: purple;"></div>No Visit</div>
        <div class="legend-item"><div class="legend-color" style="background-color: violet;"></div>UCC</div>
        <div class="legend-item"><div class="legend-color" style="background-color: pink;"></div>Overdue</div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA1aUdvuhzMqJAKGNy0ttDVS-QZNib30ZY",
            authDomain: "sales-map-ac968.firebaseapp.com",
            databaseURL: "https://sales-map-ac968-default-rtdb.firebaseio.com",
            projectId: "sales-map-ac968",
            storageBucket: "sales-map-ac968.firebasestorage.app",
            messagingSenderId: "758371444111",
            appId: "1:758371444111:web:a5f0f425522e1bf536d7fa"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const customersRef = db.ref("customers");
        window.customers = [];
        let editingId = null;
        const today = new Date();
        let geocoder;
        let currentInfoWindow = null;
        let map = null;
        let markers = [];

        firebase.auth().onAuthStateChanged((user) => {
            const authStatus = document.getElementById("auth-status");
            const signOutButton = document.getElementById("signOutButton");
            const inputs = document.querySelectorAll("#name, #address, #priority, #contactName, #phone, #emailContact, #notes, #lastVisit, #reminders, #addCustomerButton, #saveEditButton, #filter, #search");

            if (user) {
                authStatus.textContent = `Signed in as ${user.email}`;
                signOutButton.style.display = "block";
                inputs.forEach(i => i.disabled = false);
                loadCustomers();
            } else {
                authStatus.textContent = "Not signed in";
                signOutButton.style.display = "none";
                inputs.forEach(i => i.disabled = true);
                window.customers = [];
                initMap();
            }
        });

        function signIn() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            firebase.auth().signInWithEmailAndPassword(email, password)
                .catch(err => alert("Sign in failed: " + err.message));
        }

        function signOut() {
            firebase.auth().signOut();
        }

        function loadCustomers() {
            customersRef.on("value", snapshot => {
                const data = snapshot.val();
                window.customers = data ? Object.entries(data).map(([id, v]) => ({ id, ...v })) : [];
                initMap(getSelectedFilters());
            });
        }

        function geocodeAddress(address, callback) {
            if (!geocoder) geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const loc = results[0].geometry.location;
                    callback({
                        lat: loc.lat(),
                        lng: loc.lng(),
                        formattedAddress: results[0].formatted_address
                    });
                } else {
                    alert("Geocoding failed: " + status);
                    callback(null);
                }
            });
        }

        function addCustomer() {
            const address = document.getElementById("address").value;
            geocodeAddress(address, result => {
                if (!result) return;
                const newCust = {
                    name: document.getElementById("name").value || "Unnamed",
                    address: result.formattedAddress,
                    lat: result.lat,
                    lng: result.lng,
                    priority: document.getElementById("priority").value,
                    contactName: document.getElementById("contactName").value,
                    phone: document.getElementById("phone").value,
                    emailContact: document.getElementById("emailContact").value,
                    notes: document.getElementById("notes").value,
                    lastVisit: document.getElementById("lastVisit").value,
                    reminders: Array.from(document.getElementById("reminders").selectedOptions).map(o => o.value)
                };
                customersRef.push(newCust);
                clearForm();
            });
        }

        function editCustomer(id) {
            const cust = window.customers.find(c => c.id === id);
            if (!cust) return;
            document.getElementById("name").value = cust.name;
            document.getElementById("address").value = cust.address;
            document.getElementById("priority").value = cust.priority;
            document.getElementById("contactName").value = cust.contactName || "";
            document.getElementById("phone").value = cust.phone || "";
            document.getElementById("emailContact").value = cust.emailContact || "";
            document.getElementById("notes").value = cust.notes || "";
            document.getElementById("lastVisit").value = cust.lastVisit || "";
            Array.from(document.getElementById("reminders").options).forEach(opt =>
                opt.selected = cust.reminders?.includes(opt.value)
            );
            editingId = id;
            document.getElementById("saveEditButton").style.display = "block";
            document.getElementById("addCustomerButton").style.display = "none";
        }

        function saveEditedCustomer() {
            if (!editingId) return;
            const address = document.getElementById("address").value;
            geocodeAddress(address, result => {
                if (!result) return;
                const updated = {
                    name: document.getElementById("name").value || "Unnamed",
                    address: result.formattedAddress,
                    lat: result.lat,
                    lng: result.lng,
                    priority: document.getElementById("priority").value,
                    contactName: document.getElementById("contactName").value,
                    phone: document.getElementById("phone").value,
                    emailContact: document.getElementById("emailContact").value,
                    notes: document.getElementById("notes").value,
                    lastVisit: document.getElementById("lastVisit").value,
                    reminders: Array.from(document.getElementById("reminders").selectedOptions).map(o => o.value)
                };
                customersRef.child(editingId).set(updated);
                clearForm();
                editingId = null;
                document.getElementById("saveEditButton").style.display = "none";
                document.getElementById("addCustomerButton").style.display = "block";
            });
        }

        function deleteCustomer(id) {
            if (confirm("Delete this customer?")) customersRef.child(id).remove();
        }

        function clearForm() {
            document.getElementById("name").value = "";
            document.getElementById("address").value = "";
            document.getElementById("priority").value = "urgent";
            document.getElementById("contactName").value = "";
            document.getElementById("phone").value = "";
            document.getElementById("emailContact").value = "";
            document.getElementById("notes").value = "";
            document.getElementById("lastVisit").value = "";
            document.getElementById("reminders").selectedIndex = -1;
        }

        function isOverdue(c) {
            if (!c.lastVisit || !c.reminders || c.reminders.includes("never")) return false;
            const last = new Date(c.lastVisit);
            return c.reminders.some(r => {
                const months = parseInt(r);
                const due = new Date(last);
                due.setMonth(last.getMonth() + months);
                return due < today;
            });
        }

        function getSelectedFilters() {
            return Array.from(document.getElementById("filter").selectedOptions).map(o => o.value);
        }

        function applyFilter() { initMap(getSelectedFilters()); }
        function searchCustomers() {
            const term = document.getElementById("search").value.toLowerCase();
            initMap(getSelectedFilters(), term);
        }

        function initMap(filters = ["all"], search = "") {
            if (!map) {
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 7,
                    center: { lat: 35.7796, lng: -78.6382 }
                });
            }

            markers.forEach(m => m.setMap(null));
            markers = [];

            const filtered = window.customers.filter(c => {
                const overdue = isOverdue(c);
                const matchFilter = filters.includes("all") || filters.includes(c.priority) || (filters.includes("overdue") && overdue);
                const matchSearch = !search || c.name.toLowerCase().includes(search);
                return matchFilter && matchSearch;
            });

            // Update customer list
            const ul = document.getElementById("customer-list-ul");
            ul.innerHTML = "";
            filtered.sort((a,b) => a.name.localeCompare(b.name)).forEach(c => {
                const li = document.createElement("li");
                li.textContent = c.name;
                li.className = `priority-${isOverdue(c) ? "overdue" : c.priority}`;
                li.onclick = () => {
                    map.setCenter({ lat: c.lat, lng: c.lng });
                    map.setZoom(15);
                    const marker = markers.find(m => m.customerId === c.id);
                    if (marker && marker.infoWindow) {
                        if (currentInfoWindow) currentInfoWindow.close();
                        marker.infoWindow.open(map, marker);
                        currentInfoWindow = marker.infoWindow;
                    }
                };
                ul.appendChild(li);
            });

            // Add markers
            filtered.forEach(c => {
                if (!c.lat || !c.lng) return;

                let color = "gray";
                if (isOverdue(c)) {
                    color = "pink";
                } else {
                    switch (c.priority) {
                        case "urgent": color = "blue"; break;
                        case "high": color = "green"; break;
                        case "medium": color = "yellow"; break;
                        case "low": color = "red"; break;
                        case "never": color = "orange"; break;
                        case "no": color = "purple"; break;
                        case "ucc": color = "violet"; break;   // UCC = Violet pins
                        default: color = "gray";
                    }
                }

                const infoWin = new google.maps.InfoWindow({
                    content: `<h3>${c.name}</h3>
                              <p><strong>Address:</strong> ${c.address}</p>
                              <p><strong>Priority:</strong> ${c.priority.toUpperCase()}</p>
                              <p><strong>Contact:</strong> ${c.contactName || "N/A"}</p>
                              <p><strong>Phone:</strong> ${c.phone || "N/A"}</p>
                              <p><strong>Email:</strong> ${c.emailContact || "N/A"}</p>
                              <p><strong>Notes:</strong> ${c.notes || "N/A"}</p>
                              <p><strong>Last Visit:</strong> ${c.lastVisit || "Never"}</p>
                              <button onclick="editCustomer('${c.id}')">Edit</button>
                              <button onclick="deleteCustomer('${c.id}')">Delete</button>`
                });

                const marker = new google.maps.Marker({
                    position: { lat: c.lat, lng: c.lng },
                    map: map,
                    title: c.name,
                    icon: `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
                    customerId: c.id
                });

                marker.infoWindow = infoWin;
                marker.addListener("click", () => {
                    if (currentInfoWindow) currentInfoWindow.close();
                    infoWin.open(map, marker);
                    currentInfoWindow = infoWin;
                });
                markers.push(marker);
            });
        }

        window.addEventListener("resize", () => {
            if (map) google.maps.event.trigger(map, "resize");
        });
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAk5eJEWBbPMOJjybLkJvQ9vJgvFw87030&callback=initMap" async defer></script>
</body>
</html>


