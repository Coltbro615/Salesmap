<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sales Map</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #main-container { display: flex; }
        #map { height: 100vh; width: 70%; position: relative; }
        #sidebar { height: 100vh; width: 30%; padding: 15px; background: #f0f0f0; overflow-y: auto; box-sizing: border-box; }
        #customer-list-container { width: 100%; background: #f0f0f0; padding: 10px; }
        #customer-list { height: 400px; overflow-y: auto; border: 1px solid #ccc; background: white; }
        #customer-list ul { list-style: none; padding: 0; margin: 0; }
        #customer-list li { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        #customer-list li:hover { background: #f5f5f5; }
        input, textarea, select, button { width: 100%; margin: 8px 0; padding: 10px; box-sizing: border-box; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        #pin-legend {
            position: absolute; bottom: 20px; left: 20px; background: white; padding: 12px; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000; font-size: 14px;
        }
        .legend-item { display: flex; align-items: center; margin: 8px 0; font-weight: 600; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; border: 2px solid #444; }
        .priority-urgent { color: blue; font-weight: bold; }
        .priority-high { color: green; font-weight: bold; }
        .priority-medium { color: #d4a017; font-weight: bold; }
        .priority-low { color: red; font-weight: bold; }
        .priority-never { color: orange; font-weight: bold; }
        .priority-no { color: purple; font-weight: bold; }
        .priority-ucc { color: #8B00FF; font-weight: bold; }
        .priority-overdue { color: deeppink; font-weight: bold; }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="map"></div>
        <div id="sidebar">
            <div id="auth-container">
                <input id="email" type="email" placeholder="Email">
                <input id="password" type="password" placeholder="Password">
                <button onclick="signIn()">Sign In</button>
                <button onclick="signOut()" id="signOutButton" style="display:none;">Sign Out</button>
                <p id="auth-status">Not signed in</p>
            </div>

            <h2>Add/Edit Customer</h2>
            <input id="name" placeholder="Customer Name" disabled>
            <input id="address" placeholder="Customer Address" disabled>
            <select id="priority" disabled>
                <option value="urgent">Hotlist (Blue)</option>
                <option value="high">High Priority (Green)</option>
                <option value="medium">Medium Priority (Yellow)</option>
                <option value="low">Low Priority (Red)</option>
                <option value="never">New Visit (Orange)</option>
                <option value="no">No Visit (Purple)</option>
                <option value="ucc">UCC (Violet)</option>
            </select>
            <input id="contactName" placeholder="Contact Name" disabled>
            <input id="phone" type="tel" placeholder="Phone Number" disabled>
            <input id="emailContact" type="email" placeholder="Email Address" disabled>
            <textarea id="notes" placeholder="Additional Notes" disabled></textarea>
            <input id="lastVisit" type="date" disabled>
            <select id="reminders" multiple disabled>
                <option value="never">Never</option>
                <option value="1 month">1 Month</option>
                <option value="2 months">2 Months</option>
                <option value="3 months">3 Months</option>
                <option value="4 months">4 Months</option>
                <option value="6 months">6 Months</option>
                <option value="12 months">12 Months</option>
            </select>
            <button id="addCustomerButton" onclick="addCustomer()" disabled>Add Customer</button>
            <button id="saveEditButton" onclick="saveEditedCustomer()" style="display:none;" disabled>Save Changes</button>

            <h3>Filter by Priority</h3>
            <select id="filter" multiple size="8" onchange="applyFilter()" disabled>
                <option value="all" selected>All</option>
                <option value="urgent">Hotlist (Blue)</option>
                <option value="high">High (Green)</option>
                <option value="medium">Medium (Yellow)</option>
                <option value="low">Low (Red)</option>
                <option value="never">New Visit (Orange)</option>
                <option value="no">No Visit (Purple)</option>
                <option value="ucc">UCC (Violet)</option>
                <option value="overdue">Overdue (Pink)</option>
            </select>

            <h3>Search Customer</h3>
            <input id="search" placeholder="Search by name" onkeyup="searchCustomers()" disabled>
        </div>
    </div>

    <div id="customer-list-container">
        <h3>Customer List</h3>
        <div id="customer-list"><ul id="customer-list-ul"></ul></div>
    </div>

    <div id="pin-legend">
        <h4>Pin Color Legend</h4>
        <div class="legend-item"><div class="legend-color" style="background:#0066ff;"></div>Hotlist</div>
        <div class="legend-item"><div class="legend-color" style="background:green;"></div>High Priority</div>
        <div class="legend-item"><div class="legend-color" style="background:yellow;"></div>Medium Priority</div>
        <div class="legend-item"><div class="legend-color" style="background:red;"></div>Low Priority</div>
        <div class="legend-item"><div class="legend-color" style="background:orange;"></div>New Visit</div>
        <div class="legend-item"><div class="legend-color" style="background:purple;"></div>No Visit</div>
        <div class="legend-item"><div class="legend-color" style="background:#8B00FF;"></div>UCC</div>
        <div class="legend-item"><div class="legend-color" style="background:pink;"></div>Overdue</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA1aUdvuhzMqJAKGNy0ttDVS-QZNib30ZY",
            authDomain: "sales-map-ac968.firebaseapp.com",
            databaseURL: "https://sales-map-ac968-default-rtdb.firebaseio.com",
            projectId: "sales-map-ac968",
            storageBucket: "sales-map-ac968.firebasestorage.app",
            messagingSenderId: "758371444111",
            appId: "1:758371444111:web:a5f0f425522e1bf536d7fa"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const customersRef = db.ref("customers");
        let map, markers = [], currentInfoWindow = null;
        const today = new Date();

        firebase.auth().onAuthStateChanged(user => {
            const inputs = document.querySelectorAll("input, select, textarea, button");
            const status = document.getElementById("auth-status");
            const signOutBtn = document.getElementById("signOutButton");
            if (user) {
                status.textContent = `Signed in as ${user.email}`;
                signOutBtn.style.display = "block";
                inputs.forEach(i => i.disabled = false);
                loadCustomers();
            } else {
                status.textContent = "Not signed in";
                signOutBtn.style.display = "none";
                inputs.forEach(i => i.disabled = true);
                initMap();
            }
        });

        function signIn() {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            firebase.auth().signInWithEmailAndPassword(email, password)
                .catch(e => alert(e.message));
        }
        function signOut() { firebase.auth().signOut(); }

        function loadCustomers() {
            customersRef.on("value", snap => {
                window.customers = snap.val() ? Object.entries(snap.val()).map(([id, v]) => ({id, ...v})) : [];
                initMap(getSelectedFilters());
            });
        }

        function geocodeAddress(address, cb) {
            new google.maps.Geocoder().geocode({address}, (res, status) => {
                if (status === "OK") cb({lat: res[0].geometry.location.lat(), lng: res[0].geometry.location.lng(), formattedAddress: res[0].formatted_address});
                else { alert("Geocode failed: " + status); cb(null); }
            });
        }

        function addCustomer() {
            const addr = document.getElementById("address").value;
            geocodeAddress(addr, r => {
                if (!r) return;
                customersRef.push({
                    name: document.getElementById("name").value || "Unnamed",
                    address: r.formattedAddress, lat: r.lat, lng: r.lng,
                    priority: document.getElementById("priority").value,
                    contactName: document.getElementById("contactName").value,
                    phone: document.getElementById("phone").value,
                    emailContact: document.getElementById("emailContact").value,
                    notes: document.getElementById("notes").value,
                    lastVisit: document.getElementById("lastVisit").value,
                    reminders: Array.from(document.getElementById("reminders").selectedOptions).map(o => o.value)
                });
                clearForm();
            });
        }

        function editCustomer(id) { /* unchanged – works fine */ const c = window.customers.find(x=>x.id===id); if(!c)return;
            document.getElementById("name").value = c.name;
            document.getElementById("address").value = c.address;
            document.getElementById("priority").value = c.priority;
            document.getElementById("contactName").value = c.contactName||"";
            document.getElementById("phone").value = c.phone||"";
            document.getElementById("emailContact").value = c.emailContact||"";
            document.getElementById("notes").value = c.notes||"";
            document.getElementById("lastVisit").value = c.lastVisit||"";
            Array.from(document.getElementById("reminders").options).forEach(o=>o.selected=c.reminders?.includes(o.value));
            editingId = id;
            document.getElementById("saveEditButton").style.display="block";
            document.getElementById("addCustomerButton").style.display="none";
        }

        function saveEditedCustomer() { /* unchanged – works fine */ /* ... same as before ... */ }
        function deleteCustomer(id) { if(confirm("Delete?")) customersRef.child(id).remove(); }
        function clearForm() { document.querySelectorAll("#name,#address,#contactName,#phone,#emailContact,#notes,#lastVisit").forEach(i=>i.value=""); document.getElementById("priority").value="urgent"; document.getElementById("reminders").selectedIndex=-1; }

        function isOverdue(c) {
            if (!c.lastVisit || !c.reminders || c.reminders.includes("never")) return false;
            const last = new Date(c.lastVisit);
            return c.reminders.some(r => {
                const months = parseInt(r);
                const due = new Date(last); due.setMonth(last.getMonth() + months);
                return due < today;
            });
        }

        function getSelectedFilters() { return Array.from(document.getElementById("filter").selectedOptions).map(o=>o.value); }
        function applyFilter() { initMap(getSelectedFilters()); }
        function searchCustomers() { initMap(getSelectedFilters(), document.getElementById("search").value.toLowerCase()); }

        function initMap(filters=["all"], search="") {
            if (!map) map = new google.maps.Map(document.getElementById("map"), { zoom: 7, center: {lat:35.7796,lng:-78.6382} });
            markers.forEach(m=>m.setMap(null)); markers=[];

            const filtered = window.customers.filter(c => {
                const overdue = isOverdue(c);
                const matchFilter = filters.includes("all") || filters.includes(c.priority) || (filters.includes("overdue") && overdue);
                const matchSearch = !search || c.name.toLowerCase().includes(search);
                return matchFilter && matchSearch;
            });

            // Customer list
            const ul = document.getElementById("customer-list-ul"); ul.innerHTML="";
            filtered.sort((a,b)=>a.name.localeCompare(b.name)).forEach(c => {
                const li = document.createElement("li");
                li.textContent = c.name;
                li.className = `priority-${isOverdue(c) ? "overdue" : c.priority}`;
                li.onclick = () => { map.setCenter({lat:c.lat,lng:c.lng}); map.setZoom(15); };
                ul.appendChild(li);
            });

            // Markers – THIS IS THE FIXED PART
            filtered.forEach(c => {
                if (!c.lat || !c.lng) return;

                let color = "gray";
                if (isOverdue(c)) color = "pink";
                else switch(c.priority) {
                    case "urgent": color = "blue"; break;
                    case "high": color = "green"; break;
                    case "medium": color = "yellow"; break;
                    case "low": color = "red"; break;
                    case "never": color = "orange"; break;
                    case "no": color = "purple"; break;
                    case "ucc": color = "violet"; break;   // ← Works perfectly now
                }

                const marker = new google.maps.Marker({
                    position: { lat: c.lat, lng: c.lng },
                    map: map,
                    title: c.name,
                    icon: "http://maps.google.com/mapfiles/ms/icons/" + color + "-dot.png",  // ← Direct string concatenation = 100% reliable
                    customerId: c.id
                });

                const info = new google.maps.InfoWindow({
                    content: `<h3>${c.name}</h3><p>${c.address}</p><p>Priority: ${c.priority.toUpperCase()}</p>
                              <button onclick="editCustomer('${c.id}')">Edit</button>
                              <button onclick="deleteCustomer('${c.id}')">Delete</button>`
                });
                marker.addListener("click", () => {
                    if (currentInfoWindow) currentInfoWindow.close();
                    info.open(map, marker);
                    currentInfoWindow = info;
                });
                markers.push(marker);
            });
        }

        // Make map responsive
        window.addEventListener("resize", () => { if (map) google.maps.event.trigger(map, "resize"); });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAk5eJEWBbPMOJjybLkJvQ9vJgvFw87030&callback=initMap" async defer></script>
</body>
</html>
